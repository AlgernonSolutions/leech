AWSTemplateFormatVersion: 2010-09-09
Transform:
  - 'AWS::Serverless-2016-10-31'
  - 'AWS::CodeStar'
Parameters:
  ProjectId:
    Type: String
    Description: CodeStar projectId used to associate new resources to team members
  LeechBucketName:
    Type: String
    Description: Name of the bucket to be used by the leech for caching and local storage
  GraphClusterName:
    Type: String
    Description: the name used to identify the graph cluster
  GqlApiName:
    Type: String
    Description: the name used to identify the GQL API
  SensitivesTableName:
    Type: String
    Description: name to be assigned to table which hold PHI
    Default: Sensitives
  IndexTableName:
    Type: String
    Description: name to be assigned to the table which will hold the indexes
    Default: Indexes
  GraphInstanceType:
    Type: String
    Description: the type of db instance used within the cluster
    AllowedValues:
      - db.r4.large
      - db.r4.xlarge
      - db.r4.2xlarge
      - db.r4.4xlarge
      - db.r4.8xlarge
    Default: db.r4.large
  VpcCidr:
    Type: String
    Description: Cidr Block of VPC
    Default: 192.168.0.0/16
  FirstSubnetCidr:
    Type: String
    Description: Cidr Block of First Created Subnet
    Default: 192.168.1.0/24
  SecondSubnetCidr:
    Type: String
    Description: Cidr Block of Second Created Subnet
    Default: 192.168.2.0/24
  ThirdSubnetCidr:
    Type: String
    Description: Cidr Block of Third Created Subnet
    Default: 192.168.3.0/24
  CodeDeployRole:
    Type: String
    Description: IAM role to be used to deploy code to AWS
Resources:
  VpcStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProjectId: !Ref ProjectId
        VpcCidr: !Ref VpcCidr
        FirstSubnetCidr: !Ref FirstSubnetCidr
        SecondSubnetCidr: !Ref SecondSubnetCidr
        ThirdSubnetCidr: !Ref ThirdSubnetCidr
      TemplateURL: templates/vpc.yml
  S3Stack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProjectId: !Ref ProjectId
        LeechBucketName: !Ref LeechBucketName
      TemplateURL: templates/s3.yml
  DynamoStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProjectId: !Ref ProjectId
        SensitivesTableName: !Ref SensitivesTableName
        IndexTableName: !Ref IndexTableName
      TemplateURL: templates/dynamo.yml
  NeptuneStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProjectId: !Ref ProjectId
        GraphClusterName: !Ref GraphClusterName
        GraphInstanceType: !Ref GraphInstanceType
        LambdaSgId: !GetAtt VpcStack.Outputs.LambdaSgId
        FirstSubnetId: !GetAtt VpcStack.Outputs.FirstSubnetId
        FirstSubnetAZ: !GetAtt VpcStack.Outputs.FirstSubnetAZ
        SecondSubnetId: !GetAtt VpcStack.Outputs.SecondSubnetId
        SecondSubnetAZ: !GetAtt VpcStack.Outputs.SecondSubnetAZ
        ThirdSubnetId: !GetAtt VpcStack.Outputs.ThirdSubnetId
        ThirdSubnetAZ: !GetAtt VpcStack.Outputs.ThirdSubnetAZ
      TemplateURL: templates/neptune.yml
  IamStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProjectId: !Ref ProjectId
        IndexTableArn: !GetAtt DynamoStack.Outputs.IndexTableArn
        SensitivesTableArn: !GetAtt DynamoStack.Outputs.SensitivesTableArn
        LeechLogBucketArn: !GetAtt S3Stack.Outputs.LeechLogBucketArn
        LeechBucketArn: !GetAtt S3Stack.Outputs.LeechBucketArn
      TemplateURL: templates/iam.yml
  LambdaStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProjectId: !Ref ProjectId
        WorkerRoleArn: !GetAtt IamStack.Outputs.WorkerRoleArn
        LambdaSgId: !GetAtt VpcStack.Outputs.LambdaSgId
        FirstSubnetId: !GetAtt VpcStack.Outputs.FirstSubnetId
        SecondSubnetId: !GetAtt VpcStack.Outputs.SecondSubnetId
        ThirdSubnetId: !GetAtt VpcStack.Outputs.ThirdSubnetId
        GraphEndpoint: !GetAtt NeptuneStack.Outputs.GraphEndpoint
        GraphReadEndpoint: !GetAtt NeptuneStack.Outputs.GraphReadEndpoint
        DeadLetterArn: !GetAtt SqsStack.Outputs.DeadLetterQueueArn
        DeadLetterUrl: !GetAtt SqsStack.Outputs.DeadLetterQueueUrl
        FifoDeadLetterArn: !GetAtt SqsStack.Outputs.FifoDeadLetterQueueArn
        FifoDeadLetterUrl: !GetAtt SqsStack.Outputs.FifoDeadLetterQueueUrl
      TemplateURL: templates/lambda.yml
  GqlStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProjectId: !Ref ProjectId
        GqlApiName: !Ref GqlApiName
        WorkerRoleArn: !GetAtt IamStack.Outputs.WorkerRoleArn
        AphidLambdaArn: !GetAtt LambdaStack.Outputs.AphidLambdaArn
        StarterLambdaArn: !GetAtt LambdaStack.Outputs.StarterLambdaArn
        SensitivesTableName: !Ref SensitivesTableName
        SensitivesTableRegion: !Ref "AWS::Region"
      TemplateURL: templates/gql.yml
  SqsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ProjectId: !Ref ProjectId
      TemplateURL: templates/sqs.yml
Metadata:
  'AWS::CloudFormation::Designer':
    0b5b2eea-7e9d-454c-94d4-f394c6e71b88:
      size:
        width: 60
        height: 60
      position:
        x: 60
        'y': 750
      z: 1
      embeds: []
    14c7ed9a-8efa-4b0c-8d83-1342c5f8c3eb:
      size:
        width: 60
        height: 60
      position:
        x: 180
        'y': 750
      z: 1
      embeds: []
    e5db2f4a-844f-4381-965e-11e1a397c187:
      size:
        width: 60
        height: 60
      position:
        x: 420
        'y': 750
      z: 1
      embeds: []
    4e7f7174-226a-4f80-ad85-86535d3ffceb:
      size:
        width: 60
        height: 60
      position:
        x: 540
        'y': 750
      z: 1
      embeds: []
    a5668090-bc9a-4956-9c15-5db0a855b235:
      size:
        width: 60
        height: 60
      position:
        x: 1330
        'y': 730
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    0290bfe2-6c1b-4aa8-b508-2904fbe67d7d:
      size:
        width: 60
        height: 60
      position:
        x: 810
        'y': 90
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    adde90b8-3f78-42aa-b5b4-1b73ebfb7339:
      size:
        width: 60
        height: 60
      position:
        x: 810
        'y': 210
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    9ed57ab8-3b9f-4a90-b69e-f9585f299673:
      size:
        width: 60
        height: 60
      position:
        x: 1720
        'y': 460
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    3cd965b5-6bce-4792-b3d9-1f2c4be1dae6:
      size:
        width: 60
        height: 60
      position:
        x: 1470
        'y': 540
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    d65053f9-8fa4-4018-940e-05e56bcbc8fd:
      size:
        width: 60
        height: 60
      position:
        x: 1200
        'y': 430
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    cf058dc5-cb5e-4125-a30d-237405143e58:
      size:
        width: 60
        height: 60
      position:
        x: 1720
        'y': 700
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    ac060457-fddd-4e0d-aecc-8e482255db82:
      size:
        width: 60
        height: 60
      position:
        x: 1580
        'y': 470
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    0c7e5b36-d381-417d-bc6c-2d7c165bc363:
      size:
        width: 60
        height: 60
      position:
        x: 930
        'y': 90
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    e66672b8-1ef3-4766-800d-c165c38b0cc4:
      size:
        width: 60
        height: 60
      position:
        x: 930
        'y': 210
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    afe684b7-95eb-448c-bdcf-938bbd88b60c:
      size:
        width: 60
        height: 60
      position:
        x: 1820
        'y': 710
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    877ab62e-4136-449e-9f46-de8409fb3a7a:
      size:
        width: 60
        height: 60
      position:
        x: 1120
        'y': 370
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    f3e15ed0-c92d-4a19-a62d-b94f968d9f6a:
      size:
        width: 60
        height: 60
      position:
        x: 1310
        'y': 460
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    a0906c04-fe82-43cd-8fd2-e33640f6c60e:
      size:
        width: 60
        height: 60
      position:
        x: 1840
        'y': 540
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    19b59139-9f62-4417-b20e-a94c1389ff0a:
      size:
        width: 60
        height: 60
      position:
        x: 900
        'y': 810
      z: 1
      embeds: []
    f309f1b9-ac09-4838-b8df-72a9c3a235f7:
      size:
        width: 690
        height: 600
      position:
        x: 60
        'y': 90
      z: 1
      embeds:
        - 536193f1-c349-490a-a47d-e299dfa64ea5
        - 524fd573-66dd-45a5-a3e4-65291313a8e4
        - ccda3246-4d55-4c4e-a19e-fe933db6e970
        - 9fc65d22-2218-4ef3-b93b-6607326e5553
        - e94f82fc-27a5-4f3f-9c8c-9928247992fa
    536193f1-c349-490a-a47d-e299dfa64ea5:
      size:
        width: 60
        height: 60
      position:
        x: 600
        'y': 150
      z: 2
      parent: f309f1b9-ac09-4838-b8df-72a9c3a235f7
      embeds: []
      iscontainedinside:
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
    0f90e117-5e72-4d1f-a571-bcbe3a52c37e:
      size:
        width: 60
        height: 60
      position:
        x: 60
        'y': 870
      z: 1
      embeds: []
      isassociatedwith:
        - b44fc2c1-ab36-4257-9462-e28fc198c8a4
    b44fc2c1-ab36-4257-9462-e28fc198c8a4:
      size:
        width: 60
        height: 60
      position:
        x: 1580
        'y': 630
      z: 1
      embeds: []
      isassociatedwith:
        - a0906c04-fe82-43cd-8fd2-e33640f6c60e
        - adde90b8-3f78-42aa-b5b4-1b73ebfb7339
        - f3e15ed0-c92d-4a19-a62d-b94f968d9f6a
        - 0f90e117-5e72-4d1f-a571-bcbe3a52c37e
        - 877ab62e-4136-449e-9f46-de8409fb3a7a
        - afe684b7-95eb-448c-bdcf-938bbd88b60c
        - e66672b8-1ef3-4766-800d-c165c38b0cc4
        - 0c7e5b36-d381-417d-bc6c-2d7c165bc363
        - cf058dc5-cb5e-4125-a30d-237405143e58
        - ac060457-fddd-4e0d-aecc-8e482255db82
        - d65053f9-8fa4-4018-940e-05e56bcbc8fd
        - 3cd965b5-6bce-4792-b3d9-1f2c4be1dae6
        - 9ed57ab8-3b9f-4a90-b69e-f9585f299673
        - 0290bfe2-6c1b-4aa8-b508-2904fbe67d7d
        - a5668090-bc9a-4956-9c15-5db0a855b235
    aaa7ed66-f911-4519-ac02-74db02992655:
      source:
        id: f309f1b9-ac09-4838-b8df-72a9c3a235f7
      target:
        id: 19b59139-9f62-4417-b20e-a94c1389ff0a
      z: 1
    524fd573-66dd-45a5-a3e4-65291313a8e4:
      size:
        width: 240
        height: 240
      position:
        x: 90
        'y': 150
      z: 2
      parent: f309f1b9-ac09-4838-b8df-72a9c3a235f7
      embeds:
        - c664d9a9-f402-44a6-a8f3-9a91d8c74d6f
      iscontainedinside:
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
    c664d9a9-f402-44a6-a8f3-9a91d8c74d6f:
      size:
        width: 60
        height: 60
      position:
        x: 120
        'y': 210
      z: 3
      parent: 524fd573-66dd-45a5-a3e4-65291313a8e4
      embeds: []
      iscontainedinside:
        - 524fd573-66dd-45a5-a3e4-65291313a8e4
        - 524fd573-66dd-45a5-a3e4-65291313a8e4
        - 524fd573-66dd-45a5-a3e4-65291313a8e4
        - 524fd573-66dd-45a5-a3e4-65291313a8e4
      dependson:
        - 19b59139-9f62-4417-b20e-a94c1389ff0a
    ccda3246-4d55-4c4e-a19e-fe933db6e970:
      size:
        width: 150
        height: 150
      position:
        x: 90
        'y': 450
      z: 2
      parent: f309f1b9-ac09-4838-b8df-72a9c3a235f7
      embeds: []
      iscontainedinside:
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
    bfeaedd8-f016-4f9f-8705-9e22cd96087a:
      source:
        id: 524fd573-66dd-45a5-a3e4-65291313a8e4
      target:
        id: ccda3246-4d55-4c4e-a19e-fe933db6e970
      z: 2
    9fc65d22-2218-4ef3-b93b-6607326e5553:
      size:
        width: 150
        height: 150
      position:
        x: 390
        'y': 360
      z: 2
      parent: f309f1b9-ac09-4838-b8df-72a9c3a235f7
      embeds: []
      iscontainedinside:
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
    ad6d614b-501c-4d27-b37d-df90508796bc:
      source:
        id: 524fd573-66dd-45a5-a3e4-65291313a8e4
      target:
        id: 9fc65d22-2218-4ef3-b93b-6607326e5553
      z: 2
    e94f82fc-27a5-4f3f-9c8c-9928247992fa:
      size:
        width: 150
        height: 150
      position:
        x: 390
        'y': 150
      z: 2
      parent: f309f1b9-ac09-4838-b8df-72a9c3a235f7
      embeds: []
      iscontainedinside:
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
        - f309f1b9-ac09-4838-b8df-72a9c3a235f7
    2b0e5325-4e37-4ca4-96c8-e5bd8a48733b:
      source:
        id: 524fd573-66dd-45a5-a3e4-65291313a8e4
      target:
        id: e94f82fc-27a5-4f3f-9c8c-9928247992fa
      z: 2
    dd8aacd1-c1a3-409b-83b3-46e3fb5755d6:
      size:
        width: 60
        height: 60
      position:
        x: 300
        'y': 870
      z: 1
      embeds: []
    d2797fb8-7237-4a71-b509-706b4ee7bf1b:
      size:
        width: 60
        height: 60
      position:
        x: 420
        'y': 870
      z: 1
      embeds: []
    3758ff2d-4532-42f2-a7fc-5e78a3c23a41:
      size:
        width: 60
        height: 60
      position:
        x: 540
        'y': 870
      z: 1
      embeds: []
    3b7b731b-3641-4e55-9841-7259ca1660cf:
      size:
        width: 60
        height: 60
      position:
        x: 660
        'y': 870
      z: 1
      embeds: []
    12616994-028b-4f97-87fa-e1ce7bde6087:
      size:
        width: 60
        height: 60
      position:
        x: 780
        'y': 930
      z: 1
      embeds: []
    b10f32a3-e368-4dcd-8f6c-d7aef1656ed0:
      size:
        width: 60
        height: 60
      position:
        x: 900
        'y': 930
      z: 1
      embeds: []
    997f0043-ff2f-46d5-93f3-eebaec7c0e73:
      size:
        width: 60
        height: 60
      position:
        x: 1020
        'y': 800
      z: 1
      embeds: []
    f8f07f6c-cc0c-4ca1-bf40-405c50f48d54:
      size:
        width: 60
        height: 60
      position:
        x: 1020
        'y': 930
      z: 1
      embeds: []
    f2141ab7-0df3-4962-b55c-9d5067d92e55:
      size:
        width: 60
        height: 60
      position:
        x: 60
        'y': 990
      z: 1
      embeds: []
    8a28347d-b611-420f-89ac-b999085e2881:
      size:
        width: 60
        height: 60
      position:
        x: 180
        'y': 990
      z: 1
      embeds: []
    25ae1830-3f23-4632-9b12-c0a383f4158b:
      size:
        width: 60
        height: 60
      position:
        x: 300
        'y': 990
      z: 1
      embeds: []
    7e350454-6075-4255-9ff7-5b13d449e546:
      size:
        width: 60
        height: 60
      position:
        x: 420
        'y': 990
      z: 1
      embeds: []
    b3eba24a-a58a-4ac2-86bf-34a278318206:
      size:
        width: 60
        height: 60
      position:
        x: 540
        'y': 990
      z: 1
      embeds: []
    3f1e62a7-66b3-488f-8eb8-962b5fb9b1f2:
      size:
        width: 60
        height: 60
      position:
        x: 258
        'y': -1
      z: 0
      embeds: []